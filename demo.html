<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>scheduler</title>
<style type="text/css">
    .timeSlider{
		padding: 0;
		margin: 0;
		border:0;
		display: block;
		z-index: 0;
		margin-left:250px;
		position:relative;
	}
	
	.timeSliderDiv{
		height:30px;
		width:32px;
		z-index:4;
		top:0;
		position:absolute;
		background:#007acc;
	}
	.trCanvas{
		width: 768px;
		height: 30px;
		background: #f2f2ee;
		position: relative;
	}
	
	.menufix{
		position:fixed;
		left:0;
		right:0;
		bottom:0;
		top:0;
		z-index:999;
		background-color:#e4e4e4;
		display:none;
		opacity:0.4;
	}
	
	.modal{
		position:fixed;
		left:0;
		right:0;
		bottom:0;
		top:0;
		z-index:1000;
		display:none;
	}
	
	.modal-dialog{
		position:relative;
		width:600px;
		margin:30px auto;
	}
	
	.modal-content{
		position:relative;
		background-color:#f8f5f5;
		background-clip:padding-box;
		border:1px solid #d4d4d4;
		border-radius:6px;
		outline:none;
		box-shadow:0 3px 9px rgba(0,0,0,0.5);
	}

	.modal-header{
		min-height:16px;
		padding:15px;
		border-bottom:1px solid #e5e5e5;
	}
	
	.modal-title{
		margin:0;
		line-height:1.42px;
	}
	
	.modal-body{
		position:relative;
		padding:20px;
	}
	
	
	.modal-footer{
		padding :19px 20px 20px;
		text-align:right;
		margin-top:15px;
		border-top:1px solid #e5e5e5;
	}
	
	.coordinate {
		width:1px;
		height:4px;
		background-color:black;
		position:absolute;
		z-index:-1;
	}
	
	.coordinateLabDiv{
		width:20px;
		margin-left:-3px;
		top:32px;
		position:absolute;
		z-index:-1;
	}
	
	
	.leftBar{
		position:absolute;
		left:-7px;
		top:25px;
		height:15px;
		width:12px;
		background-color:#e4e4e4;
		display:none;
	}
	
	.rightBar{
		position:absolute;
		left:25px;
		top:25px;
		height:15px;
		width:12px;
		background-color:#e4e4e4;
		display:none;
	}
	
	.leftShow{
		background-color:blue;
		color:white;
		padding-left:3px;
		width:44px;
		height:19px;
		position:absolute;
		left:-30px;
		top:48px;
		display:none;
	}
	
	.rightShow{
		background-color:blue;
		color:white;
		padding-left:3px;
		width:44px;
		height:19px;
		position:absolute;
		left:18px;
		top:48px;
		display:none;
	}
	
	
	.setbtn:hover{
		background-color:#e4e4e4;
	}
	
	.setbtn{
		font-size:14px;
		line-height:1.427;
		height:40px;
		width:80px;
		text-align:center;
		border:1px solid #d8d8d8;
		margin:2px;
		border-radius:5px;
	}
	
	.time-div{
		margin-top:10px;
	}
	
	.time{
		width:20px;
		margin:10px;
	}
	.week{
		float:left;
		margin-left:30px;
	}
	
	.editWrap{
		position:relative;
		height:50px;
		width:100px;
		left:1050px;
		bottom:30px;
	}
	
	.editDiv{
		width:180px;
		position:absolute;
		left:0;
		top:0;
		display:none;
		background-color:#f9f6f6;
		border:1px solid #e4e4e4;
		z-index:5;
	}
	
	.editHeader{
		min-height:16px;
		padding:5px;
		border-bottom:1px solid #e5e5e5;
	}
	
	.editBody{
		position:relative;
		padding:10px;
	}
	
	.editFooter{
		padding :9px 2px 2px;
		text-align:right;
		margin-top:5px;
		border-top:1px solid #e5e5e5;
	}
	
	.delImg{
		position:absolute;
		left:40px;
		top:2px;
	}
	
	.delImg:hover{
		cursor:pointer;
	}
	
	.editBtn{
		font-size:14px;
		width:50px;
		text-align:center;
		margin:2px;
	}
	
</style>
</head>
<body onselectstart="return false;">
<div>
<label class="week">星期一:</label>
<div id="timeslider1" class="timeSlider" onselectstart="return false;">
</div>
</div>
<br/>
<br/>
<br/>
<div>
<label class="week">星期二:</label>
<div id="timeslider2" class="timeSlider"  onselectstart="return false;">
</div>
</div>
<br/>
<br/>
<br/>
<div>
<label class="week">星期三:</label>
<div id="timeslider3" class="timeSlider"  onselectstart="return false;">
</div>
</div>
<br/>
<br/>
<br/>
<div>
<label class="week">星期四:</label>
<div id="timeslider4" class="timeSlider"  onselectstart="return false;">
</div>
</div>
<br/>
<br/>
<br/>
<div>
<label class="week">星期五:</label>
<div id="timeslider5" class="timeSlider"  onselectstart="return false;">
</div>
</div>
<br/>
<br/>
<br/>
<div>
<label class="week">星期六:</label>
<div id="timeslider6" class="timeSlider"  onselectstart="return false;">
</div>
</div>
<br/>
<br/>
<br/>
<div>
<label class="week">星期日:</label>
<div id="timeslider7" class="timeSlider"  onselectstart="return false;">
</div>
</div>
<br/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript">
	if (typeof jQuery === 'undefined') {
		throw new Error('Slider\'s JavaScript requires jQuery')
	}
	
	var contentAyyay=new Array();//存放每个时间轴对象实例的上下文this的数组
	
	function TimeSlider(){
		this.left_array=new Array();//存放每个拖块的左坐标
		this.right_array=new Array();//存放每个拖块的右坐标
		this.leftTime_array=new Array();//存放每个拖块的左坐标对应的时间
		this.rightTime_array=new Array();//存放每个拖块的右坐标对应的时间
		this.leftTime=0;//存放当前操作拖块的时间
		this.rightTime=0;//存放当前操作拖块的时间
		this.slderLeftOffset=0;//时间轴距离左页面的距离
		this.oneDragBlockWidth=0;
		this.oneHourWidth=0;
		this.dragNum=0;//拖块个数-1
		this.hasMove=false;//判断拖块是click事件还是move事件
		this.whichOne=0;//目前操纵的是哪个拖块
		this.timeSliderNum=0;//TimeSlider实例个数
		this.calTimeFlag=false;//是否计算时间
		this.dragId=null;//当前操作的拖块的ID
	}
	
	TimeSlider.prototype={
		sliderArray : new Array(),//用来存放TimeSlider实例出来的对象
		sliderTotal:0,//TimeSlider实例个数
		
		/*创建整个时间轴的DOM结构*/
		init:function(obj){
			TimeSlider.prototype.sliderTotal++;
			this.timeSliderNum=TimeSlider.prototype.sliderTotal;
			var divId=obj.id;
			var oneDragBlockTime=obj.oneDragBlockTime||60;//每个拖块代表的时间
			var self=this;//保存当前上下文
			contentAyyay.push(this);
			/*创建布局*/
				var backgroundDiv=document.createElement("div");
				$(backgroundDiv).addClass("trCanvas").appendTo("#"+divId);
				
				var oneHourWidth=Math.floor($(backgroundDiv).width()/24);//每一个小时占的宽度
				this.oneHourWidth=oneHourWidth;
				var oneDragBlockWidth=Math.floor(oneHourWidth*oneDragBlockTime/60);//每个拖块的宽度
				this.oneDragBlockWidth=oneDragBlockWidth;
				
				for(var i=0;i<25;i++){
					var coordinateDiv=document.createElement("div");
					$(coordinateDiv).addClass("coordinate").css({
															  "left":oneHourWidth*i+"px"
															}).appendTo("#"+divId);
															
		
					var labelDiv=document.createElement("div");
					if(i<10)
					{
						$(labelDiv).addClass("coordinateLabDiv").text(i).css({
																  "left":oneHourWidth*i+"px"
																}).appendTo("#"+divId);
					}
					else{
						$(labelDiv).addClass("coordinateLabDiv").text(i).css({
																  "left":oneHourWidth*i+"px",
																  "margin-left":"-6px"
																}).appendTo("#"+divId);
					
					}
					//$(labelDiv).attr("readonly",true);
				}
				

				
				/*弹出框*/
				var menuFixedDiv=document.createElement("div");
				$(menuFixedDiv).addClass("menufix").attr("id","fixedDiv"+this.timeSliderNum)
				$("#"+divId).after(menuFixedDiv)
				
				var modalDiv=document.createElement("div");
				var modalDialogDiv=document.createElement("div");
				var modalContentDiv=document.createElement("div");
				var modalHeaderDiv=document.createElement("div");
				var modalBodyDiv=document.createElement("div");
				var modalFooterDiv=document.createElement("div");
				
				var modalTitle=document.createElement("h4");
				var modalTimeDiv=document.createElement("div");
				var setBtn=document.createElement("button");
				var delBtn=document.createElement("button");
				var calBtn=document.createElement("button");
				var startHour=document.createElement("input");
				var startMin=document.createElement("input");
				var stopHour=document.createElement("input");
				var stopMin=document.createElement("input");
				startHour.type="text";
				startHour.maxLength=2
				startMin.type="text";
				startMin.maxLength=2
				stopHour.type="text";
				stopHour.maxLength=2
				stopMin.type="text";
				stopMin.maxLength=2
				
				$(modalDiv).addClass("modal").attr("id","modalDiv"+this.timeSliderNum)
				$(modalDialogDiv).addClass("modal-dialog").appendTo(modalDiv);
				$(modalContentDiv).addClass("modal-content").appendTo(modalDialogDiv);
				$(modalHeaderDiv).addClass("modal-header").appendTo(modalContentDiv);
				$(modalTitle).addClass("modal-title").text("编辑").appendTo(modalHeaderDiv);
				$(modalBodyDiv).addClass("modal-body").appendTo(modalContentDiv);
				
				$(modalTimeDiv).addClass("time-div").appendTo(modalBodyDiv);
				$(startHour).addClass("time").appendTo(modalTimeDiv).after(":").before("开始时间").attr("id","startH"+this.timeSliderNum)
				$(startMin).addClass("time").appendTo(modalTimeDiv).attr("id","startM"+this.timeSliderNum)
				$(stopHour).addClass("time").appendTo(modalTimeDiv).after(":").before("结束时间").attr("id","stopH"+this.timeSliderNum)
				$(stopMin).addClass("time").appendTo(modalTimeDiv).attr("id","stopM"+this.timeSliderNum)
				
				$(modalFooterDiv).addClass("modal-footer").appendTo(modalContentDiv);								
				$(setBtn).addClass("setbtn").appendTo(modalFooterDiv).text("设置").attr("id","setBtn"+this.timeSliderNum)
				$(delBtn).addClass("setbtn").appendTo(modalFooterDiv).text("删除").attr("id","delBtn"+this.timeSliderNum)
				$(calBtn).addClass("setbtn").appendTo(modalFooterDiv).text("取消").attr("id","calBtn"+this.timeSliderNum)
				
				setBtn.onclick=function(){
						var STH=parseInt($("#startH"+this.timeSliderNum).val());
						var STM=parseInt($("#startM"+this.timeSliderNum).val());
						var SPH=parseInt($("#stopH"+this.timeSliderNum).val());
						var SPM=parseInt($("#stopM"+this.timeSliderNum).val());
						
						if(STH==""||STH==""||SPH==""||SPH=="")
						{
							alert("请设置");
							return
						}
						else if(STH<0||STH>23||SPH<0||SPH>24)
						{
							alert("小时请填写0-24之间的数字");
							return;
						}
						else if(STM<0||STM>59||SPM<0||SPM>59)
						{
							alert("分钟请填写0-59之间的数字");
							return;
						}
						else if(SPH<STH||(SPH==24&&SPM>0))
						{
							alert("请填写正确的时间");
							return;
						}
						else if((STH==SPH)&&(SPM<STM))
						{
							alert("这个错得太离谱")
							return;
						}
						else if((SPH*60+SPM)-(STH*60+STM)<40)
						{
							alert("间隔至少40分钟");
							return;
						}						
						var rightBarId=$("#"+this.dragId).children(".rightBar").attr("id");
						var rightShowId=$("#"+this.dragId).children(".rightShow").attr("id");
						var leftShowId=$("#"+this.dragId).children(".leftShow").attr("id");
	
						var newLeft=Math.ceil(STH*this.oneHourWidth+STM*this.oneHourWidth/60);
						var newRight=Math.ceil(SPH*this.oneHourWidth+SPM*this.oneHourWidth/60);
						var arrayLen;
						arrayLen=this.left_array.length;

						/*设置过程中判断时间段是否超出边界范围及超过其他时间段*/
						if(newLeft<0||newRight>$("#"+this.dragId).parent().width())
						{
							alert("超过时间抽长度，请重新设置");
							return 
						}
						if(arrayLen>=2)
						{	
						if(this.whichOne==0)
						{
							if(newRight>this.left_array[this.whichOne+1])
							{
								alert("与其他时间段重合，请重新设置");
								return ;
							}
						}
						else if(this.whichOne==arrayLen-1)
						{
							if(newLeft<this.right_array[this.whichOne-1])
							{
								alert("与其他时间段重合，请重新设置");
								return ;
							}
						}
						else{
								if(newLeft<this.right_array[this.whichOne-1]||newRight>this.left_array[this.whichOne+1])
								{
									alert("与其他时间段重合，请重新设置");
									return ;
								}
							}
						}
						this.left_array.splice(this.whichOne,1,newLeft);
						this.right_array.splice(this.whichOne,1,newRight);
	
						$("#"+this.dragId).css({
							"left":newLeft,
							"width":newRight-newLeft
						})
	
						$("#"+rightBarId).css({
							"left":newRight-newLeft-$("#"+rightBarId).width()/2
						})
						
						$("#"+rightShowId).css({
							"left":newRight-newLeft-$("#"+rightShowId).width()/2
						})					
						var textSTH=STH>10?STH:"0"+STH
						var textSTM=STM>10?STM:"0"+STM
						var textSPH=SPH>10?SPH:"0"+SPH
						var textSPM=SPM>10?SPM:"0"+SPM
						$("#"+rightShowId).text(textSPH+":"+textSPM);
						$("#"+leftShowId).text(textSTH+":"+textSTM);
	
						$("#modalDiv"+this.timeSliderNum).hide();
						$("#fixedDiv"+this.timeSliderNum).hide();						
				}.bind(this);
				
				delBtn.onclick=function(){						
						this.right_array.splice(this.whichOne,1);
						this.left_array.splice(this.whichOne,1);
						this.leftTime_array.splice(this.whichOne,1);
						this.rightTime_array.splice(this.whichOne,1);
						$("#"+this.dragId).remove();
						$("#modalDiv"+this.timeSliderNum).hide();
						$("#fixedDiv"+this.timeSliderNum).hide();					
				}.bind(this)
				
				calBtn.onclick=function(){						
						$("#modalDiv"+this.timeSliderNum).hide();
						$("#fixedDiv"+this.timeSliderNum).hide();		
				}.bind(this)
				
				$("#"+divId).after(modalDiv)
				
				/*end*/
				
				/*编辑区域*/
				var editWrap=document.createElement("div");
				$(editWrap).addClass("editWrap")

				$("#"+divId).after(editWrap);
				
				var editImg=document.createElement("img");
				editImg.src="edit.gif";
				$(editImg).hover(function(){
					this.style.cursor="pointer";
				})
				editImg.title="编辑";
				$(editWrap).append(editImg);
				editImg.onclick=function(){
					$("#editDiv"+this.timeSliderNum).show();
				}.bind(this);
				
				
				var delImg=document.createElement("img");
				delImg.src="del.gif";
				delImg.title="删除";
				$(delImg).addClass("delImg");
				delImg.onclick=function(){
					if(window.confirm("是否要删除此时间轴上的所有时间段"))
					{
						var len=this.right_array.length;
						for(var i=len;i--;)
						{
							$("#timeS"+this.timeSliderNum+"_"+i).remove();
						}
						this.right_array.splice(0,len);
						this.left_array.splice(0,len);
						this.rightTime_array.splice(0,len);
						this.leftTime_array.splice(0,len);
						this.dragNum=0;
					}
				}.bind(this);
				$(editWrap).append(delImg);
				
		
				var editDiv=document.createElement("div");
				$(editDiv).addClass("editDiv").attr("id","editDiv"+this.timeSliderNum)
				
				$(editWrap).append(editDiv);
				
				var editHeader=document.createElement("div");
				$(editHeader).addClass("editHeader");
				$(editDiv).append(editHeader);
				
				var editTitle=document.createElement("label")
				$(editTitle).text("复制到");
				$(editHeader).append(editTitle);
				
				var editBody=document.createElement("div");
				$(editBody).addClass("editBody");
				$(editDiv).append(editBody);
				
				var editTextObj={
					0:"星期一",
					1:"星期二",
					2:"星期三",
					3:"星期四",
					4:"星期五",
					5:"星期六",
					6:"星期日",
				}
				for(var i=0;i<7;i++)
				{
					var editBoxDiv=document.createElement("div");
					editBoxDiv.style.display="inline-block";
					$(editBody).append(editBoxDiv);
					var editCheckBox=document.createElement("input");
					editCheckBox.type="checkbox";
					editCheckBox.onclick=function(){
						$("#editCheckAll"+this.timeSliderNum).prop("checked",$(".editCBox"+this.timeSliderNum).length==$(".editCBox"+this.timeSliderNum).filter(":checked").length);
					}.bind(this);
					$(editCheckBox).addClass("editCBox"+this.timeSliderNum).attr("id","editCBox"+this.timeSliderNum+"_"+i);
					$(editBoxDiv).append(editCheckBox);
					var editLabel=document.createElement("label");
					$(editLabel).text(editTextObj[i]);
					$(editBoxDiv).append(editLabel);
					if(i==this.timeSliderNum-1)
					{
						$(editBoxDiv).remove();
					}
				}
	
					/*全选按钮*/
					var editBoxDiv=document.createElement("div");
					editBoxDiv.style.display="inline-block";
					$(editBody).append(editBoxDiv);
					var editCheckBox=document.createElement("input");
					editCheckBox.type="checkbox";
					$(editCheckBox).attr("id","editCheckAll"+this.timeSliderNum);
					$(editBoxDiv).append(editCheckBox);
					var editLabel=document.createElement("label");
					$(editLabel).text("全选");
					$(editBoxDiv).append(editLabel);
					editCheckBox.onclick=function(){
						 $(".editCBox"+this.timeSliderNum).prop("checked",$("#editCheckAll"+this.timeSliderNum).prop("checked"));
					}.bind(this);
					/*end*/
				
				var editFooter=document.createElement("div");
				$(editFooter).addClass("editFooter");
				$(editDiv).append(editFooter);
							
				var editSave=document.createElement("input");
				$(editSave).addClass("editBtn");
				editSave.type="button";
				editSave.value="保存";
				editSave.onclick=function(){
					var len=this.left_array.length;
					for(var j=0;j<7;j++)
					{
						if($("#editCBox"+this.timeSliderNum+"_"+j).prop("checked")==true)
						{
							var targetId=$(".trCanvas").eq(j).parent().attr("id");
							
							for(var i=0;i<len;i++)
							{
								contentAyyay[j].createDrag(targetId,this.left_array[i]+this.slderLeftOffset,this.right_array[i],this.leftTime_array[i],this.rightTime_array[i]);
							}
						}
						
					}
					$("#editDiv"+this.timeSliderNum).hide();
				}.bind(this)
				$(editFooter).append(editSave);
				
				var editCancle=document.createElement("input");
				$(editCancle).addClass("editBtn");
				editCancle.type="button";
				editCancle.value="取消";
				editCancle.onclick=function(){
					$("#editDiv"+this.timeSliderNum).hide();
				}.bind(this)
				$(editFooter).append(editCancle);
				
				/*end*/
			
			this.slderLeftOffset=$("#"+divId).offset().left//时间轴距离左页面的距离
			
			
			$(backgroundDiv).mousedown(function(e){
				var event=e?e:window.event;
				self.createDrag(this,event.pageX);
				/*if(document.all){  //兼容IE8
					e.cancelBubble=true;
				}else{
					e.stopPropagation();
				}*/
			})
			
			if(obj.defaultTime)
			{
				for( key in obj.defaultTime)
				{
					var timeArray=this.getSliderOffsetX(obj.defaultTime[key]);
					this.createDrag(obj.id,timeArray[0],timeArray[1],timeArray[2],timeArray[3]);
				}
			}
		},
		
		/*创建拖块函数，backgroundDiv为时间轴的背景DOM，
		ex为鼠标点击的位置，即创建的起始点，ex2代表拖块的宽度，若不存在，则默认一个小时的宽度，
		timeStart和timeStop为拖块的初始时间显示，若不存在则根据坐标进行计算，若存在则直接显示其值*/
		createDrag:function(backgroundDiv,ex,ex2,timeStart,timeStop){
			var self=this;
			var dragLeft=ex-self.slderLeftOffset;
			if(ex2)//如果指明了结束时间
			{
				var dragRight=ex2;
			}
			else{
				var dragRight=dragLeft+self.oneDragBlockWidth;
			}
			var leftArrayLength=self.left_array.length;
			
			if(typeof(backgroundDiv)=="string")
			{
				$backgroundDiv=$("#"+backgroundDiv+" > .trCanvas");
			}
			else {
				$backgroundDiv=$(backgroundDiv);
			}
			/*判断新建的时间段是否超过整个时间轴右边界*/
			if((dragLeft)>=$backgroundDiv.width()-self.oneDragBlockWidth)
			{
				console.log("超过")
				return;
			}
			
			/*判断新创建的时间段是否能放下，防止时间段重叠*/
			if(leftArrayLength>=1)
			{	
				for(var j=0;j<leftArrayLength;j++)
				{
					if(dragRight>self.left_array[j]&&dragLeft<self.right_array[j])
					{
						console.log("重叠")
						return;
					}
				}
			}		
			/*刚加入一个拖块就把其左右坐标进行保存*/
			self.left_array.push(dragLeft);
			self.right_array.push(dragRight);
			/*将拖块的坐标进行排序*/
			self.left_array.sort(function(a,b){
				return a-b;
			});
			self.right_array.sort(function(a,b){
				return a-b;
			});
			
			var sliderNum=self.timeSliderNum
			
				
			/*创建拖块*/
			var drag="<div class='timeSliderDiv'"+
					 'id=timeS'+sliderNum+'_'+self.dragNum+' '+
					 'style=left:'+dragLeft+'px'+' '+
					 'onconTextmenu="return false";'+
					 '></div>'
			
			$backgroundDiv.append(drag);
			var dragWidth=dragRight-dragLeft
			$("#timeS"+sliderNum+'_'+self.dragNum).css("width",dragWidth+"px");
			
			$("#timeS"+sliderNum+"_"+self.dragNum).mousedown(function(e){
				self.dragDown(e,this);
				if(document.all){   //兼容IE8
					e.cancelBubble=true;
				}else{
					e.stopPropagation();
				}
			})

			
			var bar_left="<div class=leftBar"+" "+
			              'id=leftBar'+sliderNum+"_"+self.dragNum+" "+			  
						 "></div>"
			$("#timeS"+sliderNum+"_"+self.dragNum).append(bar_left);
			
			$("#leftBar"+sliderNum+"_"+self.dragNum).mouseover(function(e){
					self.barOver(this);
					/*if(document.all){  //兼容IE8
						e.cancelBubble=true;
					}else{
						e.stopPropagation();
					}*/
			}).mousedown(function(e){
					self.leftBarDown(e,this);
					if(document.all){  //兼容IE8
						e.cancelBubble=true;
					}else{
						e.stopPropagation();
					}
			}).mouseup(function(e){
					self.BarUp(this,"left");
					if(document.all){  //兼容IE8
						e.cancelBubble=true;
					}else{
						e.stopPropagation();
					}
			})
			
			
			
			var bar_right="<div class=rightBar"+" "+
			              'id=rightBar'+sliderNum+"_"+self.dragNum+" "+					  
						  "></div>"
			$("#timeS"+sliderNum+"_"+self.dragNum).append(bar_right);
			
			var rightBarOffsetLeft=dragRight-dragLeft-$("#rightBar"+sliderNum+"_"+self.dragNum).width()/2
			$("#rightBar"+sliderNum+"_"+self.dragNum).css("left",rightBarOffsetLeft)
			
			$("#rightBar"+sliderNum+"_"+self.dragNum).mouseover(function(e){
					self.barOver(this);
					/*if(document.all){  //兼容IE8
						e.cancelBubble=true;
					}else{
						e.stopPropagation();
					}*/
			}).mousedown(function(e){
					self.rightBarDown(e,this);
					if(document.all){  //兼容IE8
						e.cancelBubble=true;
					}else{
						e.stopPropagation();
					}
			}).mouseup(function(e){
					self.BarUp(this,"right");
					if(document.all){  //兼容IE8
						e.cancelBubble=true;
					}else{
						e.stopPropagation();
					}
			})
			
			
			
			var left_show="<div class=leftShow"+" "+
						   'id=leftShow'+sliderNum+"_"+self.dragNum+" "+
						  "></div>"
						  
			$("#timeS"+sliderNum+"_"+self.dragNum).append(left_show);
			
			
			var right_show="<div class=rightShow"+" "+
						   'id=rightShow'+sliderNum+"_"+self.dragNum+" "+
						  "></div>"
						  
			$("#timeS"+sliderNum+"_"+self.dragNum).append(right_show);
			var rightShowOffsetLeft=dragRight-dragLeft-13;
			$("#rightShow"+sliderNum+"_"+self.dragNum).css("left",rightShowOffsetLeft)
			
			if(timeStart)
			{
					self.setSliderTime(dragLeft,'leftShow'+sliderNum+'_'+self.dragNum,timeStart);
					self.setSliderTime(dragRight,'rightShow'+sliderNum+'_'+self.dragNum,timeStop);
					self.getSliderTime();
			}
			else{
					self.setSliderTime(dragLeft,'leftShow'+sliderNum+'_'+self.dragNum);
					self.setSliderTime(dragRight,'rightShow'+sliderNum+'_'+self.dragNum);
					self.getSliderTime();
			}

			/*控制时间显示效果*/
			$("#timeS"+sliderNum+"_"+self.dragNum).hover(function(){
				$(this).addClass("hover");
				$(this).css("z-index",5);
				$(".hover .leftShow").show();
				$(".hover .rightShow").show();
				$(".hover .leftBar").show();
				$(".hover .rightBar").show();
			},function(){
				$(this).css("z-index",4);
				$(".hover .leftShow").hide();
				$(".hover .rightShow").hide();
				$(".hover .leftBar").hide();
				$(".hover .rightBar").hide();
				$(this).removeClass("hover");		
			})
			/*end*/
		
			self.dragNum++;
		},
		
		/*拖块按下事件，主要是用来拖拽拖块和点击弹出编辑框*/
		dragDown:function(e,thisDrag){
			$(thisDrag).css("z-index","5");
			$(thisDrag).css("cursor", "move");
			var self=this;
			self.hasMove=false;
			
			var rightShowId=$(thisDrag).children(".rightShow").attr("id");
			var leftShowId=$(thisDrag).children(".leftShow").attr("id");
		
			var arrayLength=self.right_array.length;
			var parentOriginalLeft=parseInt($(thisDrag).css("left"));//拖块的原始偏移量
			var disX=parseInt(e.pageX-parentOriginalLeft-self.slderLeftOffset);//鼠标在拖动块上的偏移
			var whichOne;

			/*当我去移动时间段之前，先找到当前操作的时间段在数组中的位置*/
			for(var i=0;i<arrayLength;i++)
			{	
				if(self.left_array[i]==parentOriginalLeft)
				{
					whichOne=i;
					self.whichOne=i;
					break;
				}
			}
			var parentId=$(thisDrag).attr("id");
			var timeSliderWidth=$("#"+parentId).parent().width();//整个滑动条宽度
			var maxWidth=timeSliderWidth-parseInt($("#"+parentId).css("width"))
			this.dragId=parentId;

		 document.onmousemove=function(ev)  {
			var self=this;
			self.hasMove=true;
			var l=parseInt(ev.pageX-disX-self.slderLeftOffset); //移动后的拖块偏移量
			if(l<0)
             {
              l=0;
             }
			 else if(l>=maxWidth)
             {
              l=maxWidth
             }
		
            var width=$("#"+parentId).width();
			//l+width为拖块的右坐标
			if(arrayLength==1)
			{
				$("#"+parentId).css({left: l<0?0:l + "px"});
				self.calTimeFlag=true;
			}
			else if(arrayLength==2)
			{
				if(self.whichOne==0)
				{
		
					if((l+width)<=self.left_array[self.whichOne+1])
					{
						$("#"+parentId).css({left: l<0?0:l + "px"});
						self.calTimeFlag=true;
					}			
				}
				else{

					if(l>=self.right_array[self.whichOne-1])
					{
						$("#"+parentId).css({left: l<0?0:l + "px"});
						self.calTimeFlag=true;
					}
				}
			}
			else{		
				if(self.whichOne==0)
				{
					if((l+width)<=self.left_array[self.whichOne+1])
					{		
						$("#"+parentId).css({left: l<0?0:l + "px"});
						self.calTimeFlag=true;
					}
				}
				else if(self.whichOne==arrayLength-1){
					if(l>=self.right_array[self.whichOne-1])
					{
						$("#"+parentId).css({left: l<0?0:l + "px"});
						self.calTimeFlag=true;
					}
				}
				else{
					if((l+width)<=self.left_array[self.whichOne+1]&&l>=self.right_array[self.whichOne-1])
						{
							$("#"+parentId).css({left: l<0?0:l + "px"});
							self.calTimeFlag=true;
						}
				}
				
			}
			if(document.all){  //兼容IE8
				e.cancelBubble=true;
			}else{
				e.stopPropagation();
			}
			if(self.calTimeFlag)
			{
				self.setSliderTime(l,leftShowId);
				self.setSliderTime(l+width,rightShowId);
				self.calTimeFlag=false;
			}
        }.bind(this);
		document.onmouseup=function(){
			var self=this;
			$("#"+parentId).css("z-index","4");
			$("#"+parentId).css ("cursor", "auto");

			/*保存移动后的时间段的新坐标*/
		
			var left_new=$("#"+parentId).css("left");
			left_new=parseInt(left_new);
			self.left_array[self.whichOne]=left_new;
				
			var right_new=$("#"+parentId).css("left");
			right_new=parseInt(right_new)+$("#"+parentId).width();
			self.right_array[self.whichOne]=right_new;
			
			self.getSliderTime("move");

			 document.onmousemove=null;
			 document.onmouseup=null;
			if(!self.hasMove)
			 {
				$("#startH"+self.timeSliderNum).val("");
				$("#startM"+self.timeSliderNum).val("");
				$("#stopH"+self.timeSliderNum).val("");
				$("#stopM"+self.timeSliderNum).val("");
				$("#fixedDiv"+self.timeSliderNum).show();
				$("#modalDiv"+self.timeSliderNum).show();
			 }
			 else{
			 }
			 self.hasMove=false;
		  }.bind(this);
		},
		
		
		/*左拉伸按钮鼠标按下事件 e为事件对象，thisDrag为当前操作的拖块*/
		leftBarDown:function(e,thisDrag){
			$(thisDrag).css("cursor", "w-resize");
			/*拉伸按钮会改变拖块的宽度*/
			var parentId=$(thisDrag).parent().attr("id");			
			//var parentOriginalWidth=$("#"+parentId).width();//拖块的原始宽度	
			var parentOriginalLeft=parseInt($("#"+parentId).css("left"));//拖块的原始偏移量
			var leftBarOffset=parseInt($(thisDrag).css("left"));
			
			var rightBar=$("#"+parentId).children(".rightBar").attr("id");//右拉伸按钮
			var rightBarLeft=parseInt($("#"+rightBar).css("left"));
			var barWidth=$("#"+rightBar).width();//拉伸按钮的宽度
			
			var rightShowId=$("#"+parentId).children(".rightShow").attr("id");//显示具体时间的div
			var rightShowLeft=parseInt($("#"+rightShowId).css("left"));
			
			var leftShowId=$("#"+parentId).children(".leftShow").attr("id");//显示具体时间的div
			var leftShowLeft=parseInt($("#"+leftShowId).css("left"));	
			
			var whichOne;
			var self=this;
			var timeSliderWidth=$(thisDrag).parent().parent().width();//整个滑动条宽度
			/*寻找目前操作的拖块的坐标在数组中的索引*/
			for(var i=0;i<self.left_array.length;i++)
			{	
				if(self.left_array[i]==parentOriginalLeft)
				{
					whichOne=i;
					self.whichOne=i;
					break;
				}
			}
			
			/*绑定拉伸条的移动事件*/
		 $(document).bind('mousemove', function (ev) {
            var pageX=parseInt(ev.pageX-self.slderLeftOffset);
            if(pageX<=0)
               {
					pageX=0;
			   }
            else if(pageX>=timeSliderWidth)
                {
					pageX=timeSliderWidth;
				}

            var parentBlock;
			var parentWidth=parseInt(self.right_array[i]-pageX);
            if(parentOriginalLeft>=pageX){
			//左拉
				if(self.whichOne==0)
				{
					parentBlock=parseInt(parentOriginalLeft-pageX);
					$("#"+parentId).css({width:parentWidth + "px",left:pageX+"px"});
					$("#"+rightBar).css({left:parentBlock+rightBarLeft+"px"});
					$("#"+rightShowId).css({left:parentBlock+rightShowLeft+"px"});
					self.calTimeFlag=true;
				}
				else{
				if(pageX>=self.right_array[self.whichOne-1])
				 {
					parentBlock=parseInt(parentOriginalLeft-pageX);
					$("#"+parentId).css({width:parentWidth + "px",left:pageX+"px"});
					$("#"+rightBar).css({left:parentBlock+rightBarLeft+"px"});
					$("#"+rightShowId).css({left:parentBlock+rightShowLeft+"px"});
					self.calTimeFlag=true;
				 }
				}
           }
			else{
			//右拉
                if(parentWidth>=self.oneDragBlockWidth/2){
					 $("#"+parentId).css({width:parentWidth + "px",left:pageX+"px"});
					 $("#"+rightBar).css({left:parentWidth-barWidth/2+"px"});
					 $("#"+rightShowId).css("left",parentWidth-14+"px");
					 self.calTimeFlag=true;
                }
            }
           
       
				
			if(self.calTimeFlag)
			{			 
				 self.setSliderTime(pageX,leftShowId);
				 self.calTimeFlag=false;
			}
      
        }).bind("mouseup",function(){
			self.BarUp(thisDrag,"left");
		})
		
		},
	
		/*拉伸条mouseover事件*/
		barOver:function(thisDrag){
			$(thisDrag).css ("cursor", "e-resize");
		},
		
		/*拉伸按钮鼠标松开事件thisDrag为当前操作的拖块,direction为当前是操作的左边拉伸按钮还是右边拉伸按钮*/
		BarUp:function(thisDrag,direction){
			var parentId=$(thisDrag).parent().attr("id");
			var self=this;
			$(thisDrag).css("cursor", "default");
			$(thisDrag).unbind("mousemove");
			$("#"+parentId).unbind("mousemove");
			$(document).unbind("mousemove");
			$(document).unbind("mouseup");
			if(direction=="left")
			{
				var left_new=parseInt($("#"+parentId).css("left"));
				self.left_array[self.whichOne]=left_new;
			}
			else if(direction=="right"){
				var right_new=parseInt($("#"+parentId).css("left"))+$("#"+parentId).width();
				self.right_array[self.whichOne]=right_new;
			}
			self.getSliderTime("move");
		},
		
		/*右拉伸按钮鼠标按下事件 e为事件对象，thisDrag为当前操作的拖块*/
		rightBarDown:function(e,thisDrag){
			var parentId=$(thisDrag).parent().attr("id");
			var rightShowId=$("#"+parentId).children(".rightShow").attr("id");
			var rightShowLeft=$("#"+rightShowId).css("left");
			var parentOriginalLeft=parseInt($("#"+parentId).css("left"));//拖块的原始偏移量
			var whichOne;
			var self=this;
			var timeSliderWidth=$(thisDrag).parent().parent().width();//整个滑动条宽度
			var rightBar=$("#"+parentId).children(".rightBar").attr("id");//右拉伸按钮
			var barWidth=$("#"+rightBar).width();//拉伸按钮的宽度
			/*寻找目前操作的拖块的坐标在数组中的索引*/
			for(var i=0;i<self.right_array.length;i++)
			{	
				if(self.left_array[i]==parentOriginalLeft)
				{
					whichOne=i;
					self.whichOne=i;
					break;
				}
			}
		
			$(document).bind('mousemove',function(ev){
				var pageX=parseInt(ev.pageX-self.slderLeftOffset);
					if(pageX<=0)
						{
							pageX=0;
						}
					else if(pageX>=timeSliderWidth)
						{
							pageX=timeSliderWidth;
						}
			
				var parentWidth=pageX>parentOriginalLeft?pageX-parentOriginalLeft:self.oneDragBlockWidth/2;
				if(pageX>=parentOriginalLeft&&parentWidth>=self.oneDragBlockWidth/2)
				{
					if(whichOne==self.left_array.length-1)
					{
						$(thisDrag).css({left:parentWidth-barWidth/2 +"px"});
						$("#"+parentId).css({width:parentWidth + "px"});
						$("#"+rightShowId).css({left:parentWidth-14 + "px"});
						self.calTimeFlag=true;
					}
					else{
						if(pageX<=self.left_array[whichOne+1])
						{
							$(thisDrag).css({left:parentWidth-barWidth/2 +"px"});
							$("#"+parentId).css({width:parentWidth + "px"});
							$("#"+rightShowId).css({left:parentWidth-14 + "px"});
							self.calTimeFlag=true;
						}
					}
				}
				else{
					$(thisDrag).css({left:parentWidth-barWidth/2 +"px"});
					$("#"+parentId).css({width:parentWidth + "px"});
					$("#"+rightShowId).css({left:parentWidth-14 + "px"});
					self.calTimeFlag=true;
				}
			
       
				if(self.calTimeFlag)
				{
				self.setSliderTime(pageX,rightShowId);
				self.calTimeFlag=false;
				}
      
			}).mouseup(function () {
				self.BarUp(thisDrag,"right");
			});
			},
		/*设置当前的显示时间
		  参数offsetX为偏移量，id为显示时间的DOM id， timeString为传进来的具体时间，若此值存在则代表手动设置时间显示，并不是移动过程中的时间显示，前者更精确
		*/
		setSliderTime:function(offsetX,id,timeString){
				var direction=id.substring(0,1);
				if(timeString)
				{
					$("#"+id).text(timeString);
					if(direction=="l")
					{
						this.leftTime=timeString;
					}
					else{
						this.rightTime=timeString;
					}
				}
				else{
					var self=this;
					var tmpHour= Math.floor(offsetX/self.oneHourWidth);
					var hour=tmpHour.toString().length<2?"0"+tmpHour:tmpHour;
					var min=parseInt(offsetX%self.oneHourWidth*60/self.oneHourWidth);
					if(min<10)
					{
						min="0"+min;
					}
					$("#"+id).text(hour+":"+min);
					if(direction=="l")
					{
						this.leftTime=hour+":"+min;
					}
					else{
						this.rightTime=hour+":"+min;
					}
				}
			},
		/*获取当前的拖块的显示时间，并存入数组，按从小到大顺序排列*/
		getSliderTime:function(action){
					if(action=="move")
					{
						this.leftTime_array[this.whichOne]=this.leftTime;
						this.rightTime_array[this.whichOne]=this.rightTime;
					}
					else{
						this.leftTime_array.push(this.leftTime);
						this.rightTime_array.push(this.rightTime);
					}
					this.leftTime_array.sort(function(a,b){
						var A=parseInt(a.split(":")[0])*60+parseInt(a.split(":")[1]);
						var B=parseInt(b.split(":")[0])*60+parseInt(b.split(":")[1]);
						return A-B;
					});
					this.rightTime_array.sort(function(a,b){
						var A=parseInt(a.split(":")[0])*60+parseInt(a.split(":")[1]);
						var B=parseInt(b.split(":")[0])*60+parseInt(b.split(":")[1]);
						return A-B;
					});
		},
		/*获取当前对应时间的left偏移量，参数time为传进来的时间数组
			返回值：
			timeArray[0]为开始时间对应的偏移量
			timeArray[1]为结束时间对应的偏移量
			timeArray[2]为传进来的开始时间,主要是为了显示正确
			timeArray[3]为传进来的结束时间,主要是为了显示正确
		*/
		getSliderOffsetX:function(time){
			var timeArray=new Array;
			var self=this;
			var startH=parseInt(time[0].split(":")[0])*self.oneHourWidth;
			var startM=parseInt(time[0].split(":")[1])*self.oneHourWidth/60;
			startM=Math.ceil(startM);
			var stopH=parseInt(time[1].split(":")[0])*self.oneHourWidth;
			var stopM=parseInt(time[1].split(":")[1])*self.oneHourWidth/60;
			stopM=Math.ceil(stopM);
			var startTime=startH+startM+self.slderLeftOffset;
			var stopTime=stopH+stopM
			timeArray[0]=startTime;
			timeArray[1]=stopTime;
			timeArray[2]=time[0];
			timeArray[3]=time[1];
			return timeArray
		},
	}
	
	/* 动态创建7个时间轴 */
	var timeS1=new TimeSlider;
	timeS1.init({
				id:"timeslider1",
				defaultTime:{
					"1":["01:01","02:42"],
					"2":["12:00","13:43"]
				}
				})
	var timeS2=new TimeSlider;
	timeS2.init({
				id:"timeslider2",
				})

	var timeS3=new TimeSlider;
	timeS3.init({
				id:"timeslider3",
				})

	var timeS4=new TimeSlider;
	timeS4.init({
				id:"timeslider4",
				})

	var timeS5=new TimeSlider;
	timeS5.init({
				id:"timeslider5",
				})
	var timeS6=new TimeSlider;
	timeS6.init({
				id:"timeslider6",
				})
    var timeS7=new TimeSlider;
	timeS7.init({
				id:"timeslider7",
				})

</script>

</body>
</html>